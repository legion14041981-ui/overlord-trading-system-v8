# [SEC-003] Automated Secret Rotation CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-rotation
  namespace: overlord
  labels:
    app: secret-rotation
    security: automation
spec:
  schedule: "0 0 */30 * *"  # Every 30 days at midnight
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Prevent overlapping runs
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: secret-rotation
        spec:
          serviceAccountName: overlord-sa
          restartPolicy: OnFailure
          containers:
          - name: rotate-secrets
            image: amazon/aws-cli:latest
            env:
            - name: AWS_REGION
              value: "us-east-1"
            - name: DB_HOST
              value: "postgres.overlord.svc.cluster.local"
            - name: DB_USER
              value: "overlord"
            - name: NAMESPACE
              value: "overlord"
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "üîÑ Starting secret rotation..."
              
              # Get current password from AWS Secrets Manager
              OLD_PASSWORD=$(aws secretsmanager get-secret-value \
                --secret-id overlord/database \
                --query SecretString --output text | jq -r '.password')
              
              # Generate new secure password
              NEW_PASSWORD=$(openssl rand -base64 32)
              
              # Update AWS Secrets Manager
              echo "üìù Updating AWS Secrets Manager..."
              aws secretsmanager update-secret \
                --secret-id overlord/database \
                --secret-string "{\"username\":\"overlord\",\"password\":\"$NEW_PASSWORD\"}"
              
              # Update database password
              echo "üîê Updating database password..."
              PGPASSWORD="$OLD_PASSWORD" psql \
                -h "$DB_HOST" \
                -U "$DB_USER" \
                -d postgres \
                -c "ALTER USER $DB_USER PASSWORD '$NEW_PASSWORD';"
              
              # Trigger External Secrets sync
              echo "üîÑ Triggering External Secrets sync..."
              kubectl annotate externalsecret overlord-db-credentials \
                force-sync="$(date +%s)" \
                --overwrite \
                -n "$NAMESPACE"
              
              # Wait for secret to propagate
              sleep 10
              
              # Rolling restart of pods to pick up new secret
              echo "‚ôªÔ∏è Restarting API pods..."
              kubectl rollout restart deployment/overlord-api -n "$NAMESPACE"
              kubectl rollout status deployment/overlord-api -n "$NAMESPACE" --timeout=5m
              
              # Test database connectivity with new credentials
              echo "‚úÖ Testing database connectivity..."
              PGPASSWORD="$NEW_PASSWORD" psql \
                -h "$DB_HOST" \
                -U "$DB_USER" \
                -d overlord \
                -c "SELECT 1;" > /dev/null
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Secret rotation completed successfully!"
                # Update Prometheus metric (success)
                echo 'overlord_secret_rotation_failed 0' | curl --data-binary @- \
                  http://prometheus-pushgateway.monitoring.svc.cluster.local:9091/metrics/job/secret-rotation
              else
                echo "‚ùå Database connectivity test failed!"
                exit 1
              fi
            volumeMounts:
            - name: kubectl-config
              mountPath: /root/.kube
          volumes:
          - name: kubectl-config
            secret:
              secretName: overlord-sa-token
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: overlord-sa
  namespace: overlord
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/overlord-secrets-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-rotation-role
  namespace: overlord
rules:
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets"]
  verbs: ["get", "list", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments/status"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-rotation-binding
  namespace: overlord
subjects:
- kind: ServiceAccount
  name: overlord-sa
  namespace: overlord
roleRef:
  kind: Role
  name: secret-rotation-role
  apiGroup: rbac.authorization.k8s.io
