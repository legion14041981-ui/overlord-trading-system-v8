# [DEP-002] Values для Production окружения
# Максимальная отказоустойчивость и безопасность

global:
  environment: production
  region: us-east-1

image:
  registry: 123456789012.dkr.ecr.us-east-1.amazonaws.com
  repository: overlord-api
  tag: ""  # Использует Chart.AppVersion
  pullPolicy: IfNotPresent

replicaCount: 5

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 2
    maxUnavailable: 0  # Zero-downtime deployment

resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 20
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 600  # 10 минут перед scale-down
      policies:
      - type: Percent
        value: 25
        periodSeconds: 120
      - type: Pods
        value: 1
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15

podDisruptionBudget:
  enabled: true
  minAvailable: 4  # Всегда 4+ пода доступны

ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/rate-limit: "1000"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/proxy-body-size: "20m"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://legion.ai"
  hosts:
    - host: overlord.legion.ai
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: overlord-production-tls
      hosts:
        - overlord.legion.ai

env:
  - name: ENV
    value: production
  - name: LOG_LEVEL
    value: info
  - name: PYTHONUNBUFFERED
    value: "1"

# Используем внешний RDS
postgresql:
  enabled: false
  external:
    host: overlord-prod.abcdef.us-east-1.rds.amazonaws.com
    port: 5432
    database: overlord
    username: overlord

# Используем внешний ElastiCache
redis:
  enabled: false
  external:
    host: overlord-prod.cache.amazonaws.com
    port: 6379

serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s

networkPolicy:
  enabled: true  # Обязательно в production

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/overlord-production

# Anti-affinity для разнесения по зонам
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchExpressions:
        - key: app.kubernetes.io/name
          operator: In
          values:
          - overlord
      topologyKey: topology.kubernetes.io/zone
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: node.kubernetes.io/instance-type
          operator: In
          values:
          - c6i.xlarge
          - c6i.2xlarge
