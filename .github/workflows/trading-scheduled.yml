name: ğŸ¤– Scheduled Trading Execution

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OVERLORD v8.1 - GitHub-Native Scheduled Trading
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# Purpose: Execute trading cycles directly on GitHub Actions
# Mode: Scheduled batch processing
# Frequency: Every 15 minutes (configurable)
# Runtime: <10 minutes per cycle
# State: Persisted to external storage (GitHub API / Database)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  # Scheduled execution every 15 minutes
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      trading_mode:
        description: 'Trading mode'
        required: false
        default: 'dry-run'
        type: choice
        options:
          - dry-run
          - conservative
          - standard
      
      max_positions:
        description: 'Maximum positions to open'
        required: false
        default: '3'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TRADING_MODE: ${{ github.event.inputs.trading_mode || 'conservative' }}
  MAX_POSITIONS: ${{ github.event.inputs.max_positions || '3' }}

concurrency:
  group: trading-execution
  cancel-in-progress: false  # Never cancel running trades

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Pre-Trading Health Check
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pre-flight-check:
    name: ğŸ” Pre-Flight Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    outputs:
      status: ${{ steps.health.outputs.status }}
      market_open: ${{ steps.market.outputs.is_open }}
    
    steps:
      - name: ğŸ“Š Check Trading Hours
        id: market
        run: |
          hour=$(date -u +%H)
          day=$(date -u +%u)
          
          # Simple check: weekday 6:00-22:00 UTC (crypto 24/7, stocks market hours)
          if [ $day -ge 1 ] && [ $day -le 5 ] && [ $hour -ge 6 ] && [ $hour -le 22 ]; then
            echo "is_open=true" >> $GITHUB_OUTPUT
            echo "âœ… Market hours: OPEN"
          else
            echo "is_open=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ Market hours: CLOSED"
          fi
      
      - name: ğŸ¥ System Health Check
        id: health
        run: |
          echo "status=healthy" >> $GITHUB_OUTPUT
          echo "âœ… System health: OK"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Execute Trading Cycle
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  trading-execution:
    name: ğŸ’¹ Execute Trading Cycle
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [pre-flight-check]
    
    # Only run if market is open (can be overridden for crypto)
    if: needs.pre-flight-check.outputs.market_open == 'true'
    
    steps:
      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“¥ Pull Latest Production Image
        run: |
          echo "Pulling: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      
      - name: ğŸ“Š Fetch Current State
        id: state
        run: |
          # In real implementation: fetch from API/database
          echo "Fetching current trading state..."
          echo "state_hash=$(date +%s)" >> $GITHUB_OUTPUT
      
      - name: ğŸ¤– Execute Trading Cycle
        id: trading
        env:
          TRADING_MODE: ${{ env.TRADING_MODE }}
          MAX_POSITIONS: ${{ env.MAX_POSITIONS }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          EXCHANGE_API_KEY: ${{ secrets.EXCHANGE_API_KEY }}
          EXCHANGE_API_SECRET: ${{ secrets.EXCHANGE_API_SECRET }}
        run: |
          echo "ğŸš€ Starting trading cycle..."
          echo "Mode: $TRADING_MODE"
          echo "Max positions: $MAX_POSITIONS"
          
          # Execute trading cycle via Docker
          docker run --rm \
            --name overlord-trading-cycle \
            -e TRADING_MODE="$TRADING_MODE" \
            -e MAX_POSITIONS="$MAX_POSITIONS" \
            -e DATABASE_URL="$DATABASE_URL" \
            -e REDIS_URL="$REDIS_URL" \
            -e EXCHANGE_API_KEY="$EXCHANGE_API_KEY" \
            -e EXCHANGE_API_SECRET="$EXCHANGE_API_SECRET" \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            python -m src.trading.executor --mode cycle --timeout 480
          
          echo "âœ… Trading cycle completed"
          echo "executed=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ’¾ Save Execution State
        if: always()
        run: |
          # Save execution metadata
          cat > execution-state.json <<EOF
          {
            "workflow_run": "${{ github.run_id }}",
            "execution_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "trading_mode": "${{ env.TRADING_MODE }}",
            "status": "${{ steps.trading.outcome }}",
            "market_conditions": "captured"
          }
          EOF
          
          cat execution-state.json
          echo "State saved for audit trail"
      
      - name: ğŸ“¤ Upload Execution Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-execution-${{ github.run_id }}
          path: |
            execution-state.json
          retention-days: 30
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Post-Trading Analysis & Notification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  post-execution-summary:
    name: ğŸ“Š Post-Execution Summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [trading-execution]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Execution Summary
        run: |
          echo "# ğŸ¤– Trading Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trading Mode:** ${{ env.TRADING_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.trading-execution.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.trading-execution.result }}" == "success" ]; then
            echo "## âœ… Execution Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "Trading cycle completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Execution Status: ${{ needs.trading-execution.result }}" >> $GITHUB_STEP_SUMMARY
            echo "Review logs for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Next Execution" >> $GITHUB_STEP_SUMMARY
          echo "Scheduled in ~15 minutes (schedule cron)" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notification (Optional)
        if: needs.trading-execution.result != 'success'
        run: |
          echo "âš ï¸ Trading execution had issues"
          echo "Consider implementing webhook notification to Slack/Discord/Telegram"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Notes:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. State Management:
#    - Current state stored in external database (PostgreSQL)
#    - Workflow artifacts for audit trail only
#
# 2. Secrets Required:
#    - DATABASE_URL: Connection to PostgreSQL
#    - REDIS_URL: For caching and rate limiting
#    - EXCHANGE_API_KEY: Trading exchange API key
#    - EXCHANGE_API_SECRET: Trading exchange API secret
#
# 3. Execution Frequency:
#    - Default: Every 15 minutes
#    - Adjustable via cron expression
#    - Minimum: Every 5 minutes (GitHub limit)
#
# 4. Limitations:
#    - Each job must complete within 10 minutes
#    - No persistent local state between runs
#    - Dependent on external services availability
#
# 5. Safety:
#    - Pre-flight checks prevent execution during market close
#    - Concurrency group prevents overlapping executions
#    - Trading mode defaulted to 'conservative'
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
